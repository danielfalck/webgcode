<!DOCTYPE html >
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>g-code simulator</title>
    <script src="webapp/libs/jquery.min.js"></script>
    <script src="webapp/libs/jquery.flot.min.js"></script>
    <script src="webapp/libs/jquery.flot.resize.js"></script>
    <script src="webapp/libs/Three.js"></script>
    <script src="webapp/libs/TrackballControls.js"></script>
    <script src="webapp/libs/jsparse.js"></script>
    <script src="webapp/cnc/geometry.js"></script>
    <script src="webapp/cnc/simulation.js"></script>
    <script src="webapp/cnc/parser.js"></script>
    <style>
        .editBlock {
            position: relative;
            float: left;
            width: 49%;
            height: 400px;
            padding: 1px;
            margin: 0;
            text-align: right;
        }

        .editBlock textarea {
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            height: 90%;
        }


        #container {
            float: right;
            background: #3FB0A5;
            width: 50%;
            height: 400px;
        }
    </style>
</head>
<body> 


<p>CNC Toolpath Simulator</p>

<p>
    Paste your g-code in the left window and see the 3D preview of your toolpath on the right.<br>
    The right pane is interactive, drag it to zoom in and out.
</p>


<div id="container"></div>
<div class="editBlock">
    <textarea id="codebox">
G18 G20 (X-Z plane for lathe inch mode)
G0 Z1.0
Z.05
G1 Z0
X.375
G2 Z-.125 X.5 R.125
G1 Z-.75
G3 X.625 Z-.875 R.125
G2 X.75 Z-1.0 R.125
G1 Z-1.5
G0 X1.0


    </textarea>
    <button onclick="backplot();">BackPlot</button>

    <button onclick="ISOView();">ISO View</button>
    <button onclick="flatView();">XY View</button>

    <button onclick="latheView();">XZ View</button>
    <button onclick="ZoomOut();">Zoom Out</button>

</div>
<script>
    function render() {
        renderer.render(scene, camera);
    }

    var WIDTH = 600;
    var HEIGHT = 400;
    var mouse = new THREE.Vector2(), INTERSECTED;
    projector = new THREE.Projector();
    raycaster = new THREE.Raycaster();
    var $container = $('#container');
    var renderer = new THREE.WebGLRenderer({antialias: true});
    var zoom = 25;
    var camera = new THREE.PerspectiveCamera(zoom, WIDTH / HEIGHT, 0.1, 20000);
//var camera = new THREE.OrthographicCamera( WIDTH/ - 2, WIDTH/ 2, HEIGHT/ 2, HEIGHT/ - 2, 0.1, 20000 );
    var scene = new THREE.Scene();
    camera.useQuaternion == true
    camera.position.x = 200;
    camera.position.y = -200;
    camera.position.z = 200;
    camera.up.set(0, 0, 1);
    renderer.setSize(WIDTH, HEIGHT);
    $(window).resize(function () {
        camera.aspect = $container.width() / $container.height();
        camera.updateProjectionMatrix();
        renderer.setSize($container.width(), $container.height());
        renderer.render(scene, camera);
    });
    $container.append(renderer.domElement);
    scene.add(camera);
    controls = new THREE.TrackballControls(camera, $container[0]);
    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.8;
    controls.noZoom = false;
    controls.noPan = false; controls.noRotate =false 
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.3;
    controls.minDistance = 3;
    controls.keys = [ 65, 83, 68 ];
    controls.addEventListener('change', function () {
        renderer.render(scene, camera);
    });
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        render();
    }
    var mesh = null;
    var contourMesh = null;
    var contourLines = [];
    var planeGeometry = new THREE.PlaneGeometry(10, 10, 5, 5);
//scene.add(new THREE.Mesh(planeGeometry, new THREE.MeshBasicMaterial({wireframe: true, color: 0x00CC00})));
    function createAxis(x, y, z, color) {
        var geom = new THREE.Geometry();
        geom.vertices.push(new THREE.Vector3(0, 0, 0));
        geom.vertices.push(new THREE.Vector3(x, y, z));
        return new THREE.Line(geom, new THREE.LineBasicMaterial({color: color}));
    }
    var axes = new THREE.Object3D();
    axes.add(createAxis(1, 0, 0, 0xFF0000));
    axes.add(createAxis(0, 1, 0, 0x00FF00));
    axes.add(createAxis(0, 0, 1, 0x0000FF));
    scene.add(axes);
    animate();

</script>
<script>
/**
    window.addEventListener("message", function (event) {
        if (event.data['type'] == 'gimme program') {
            evaluateCode();
            event.source.postMessage({type: 'program', program: $('#codebox').val()}, event.origin);
        }
        if (event.data['type'] == 'toolPosition') {
            var pos = event.data['position'];
            $('#toolPos').attr('translation', [pos.x, pos.y, pos.z].join(' '));
            $('#toolPos').attr('render', true);
            tool.position.setX(pos.x);
            tool.position.setY(pos.y);
            tool.position.setZ(pos.z);
            tool.traverse(function (child) {
                child.visible = true;
            });
            renderer.render(scene, camera);
        }
    }, false);
*/
function backplot(){
    evaluateCode();
}
</script>
<script>
    function flatView()
    {
        var viewtype=1;

        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 300;
        camera.up.set(0, 1, 0);
        zoom=15;
    }
</script>

<script>
    function latheView()
    {
        var viewtype=2;
        camera.position.x = 0;
        camera.position.y = 300;
        camera.position.z = 0;
        camera.up.set(1, 0, 0);
        zoom=15;
    }
</script>
<script>
    function ISOView()
    {
        var viewtype=3;
        camera.position.x = 200;
        camera.position.y = -200;
        camera.position.z = 200;
        camera.up.set(0, 0, 1);
        zoom=15;
    }
</script>
<script>
    function ZoomOut()
    {
        if (viewtype=1)
        {   zoom=zoom+5;

            camera.position.z = zoom;
            camera.up.set(0, 1, 0);
            console.log("viewtype:", viewtype);
        }
        else if (viewtype=2)
        {
            zoom=zoom-5;
            camera.position.x = 0;
            camera.position.z = 0;

            camera.position.y = zoom;
            camera.up.set(1, 0, 0);
console.log("viewtype:", viewtype);

        }
        else if(viewtype=3)
        {   zoom=zoom+5;

            camera.position.x = zoom;
            camera.position.y = -zoom;
            camera.position.z = zoom;
            camera.up.set(0, 0, 1);
console.log("viewtype:", viewtype);


        }

    }
</script>
</body>
</html>

